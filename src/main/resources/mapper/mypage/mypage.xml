<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.haebub.dao.mypage.MypageMapper">
    <select id="lectureListDtos" parameterType="int" resultType="com.haebub.dto.mypage.LectureListDTO">
        SELECT
                  p.lid AS lid
                , ltitle
                , DATE(ptime) AS startDate
                , DATE_ADD(DATE(ptime), INTERVAL lperiod DAY) AS endDate
                , tsubject
                , NAME
                , DATE(NOW()) AS now
                , CASE
                      WHEN DATEDIFF(DATE_ADD(DATE(ptime), INTERVAL lperiod DAY), DATE(NOW())) >= 0 THEN 'Ongoing'
                      WHEN DATE(NOW()) > DATE_ADD(DATE(ptime), INTERVAL lperiod DAY) THEN 'Completed' END AS status
        FROM purchase p
            INNER JOIN lecture l ON p.lid = l.lid
            INNER JOIN teacher t ON l.tid = t.tid
            INNER JOIN user u ON t.uid = u.uid
        WHERE  p.uid = #{uid}
        AND DATEDIFF(DATE_ADD(DATE(p.ptime), INTERVAL l.lperiod DAY), DATE(NOW())) >= 0
    </select>
    <select id="lectureListDtos2" parameterType="int" resultType="com.haebub.dto.mypage.LectureListDTO">
        SELECT
                  ltitle
                , DATE(ptime) AS startDate
                , DATE_ADD(DATE(ptime), INTERVAL lperiod DAY) AS endDate
                , tsubject
                , NAME
                , DATE(NOW()) AS now
                , CASE
                    WHEN DATEDIFF(DATE_ADD(DATE(ptime), INTERVAL lperiod DAY), DATE(NOW())) >= 0 THEN 'Ongoing'
                    WHEN DATE(NOW()) > DATE_ADD(DATE(ptime), INTERVAL lperiod DAY) THEN 'Completed' END AS status
        FROM purchase p
            INNER JOIN lecture l ON p.lid = l.lid
            INNER JOIN teacher t ON l.tid = t.tid
            INNER JOIN user u ON t.uid = u.uid
        WHERE  p.uid = #{uid}
        AND DATE(NOW()) > DATE_ADD(DATE(p.ptime), INTERVAL l.lperiod DAY)
    </select>
    <select id="getUid" parameterType="string" resultType="int">
        SELECT uid
        FROM user
        WHERE id = #{id}
    </select>
    <select id="paidList" parameterType="int" resultType="com.haebub.dto.mypage.PaidDTO">
        SELECT ptime
        , ltitle
        , lprice
        , tsubject
        , NAME
        , DATE(ptime) AS 'startDate'
        , DATE_ADD(DATE(ptime), INTERVAL + lperiod DAY) AS 'endDate'
        FROM purchase p, lecture l, teacher t, user u
        WHERE p.lid = l.lid
        AND l.tid = t.tid
        AND t.uid = u.uid
        <!-- pstatus 값 수정하기   -->
        AND pstatus = 'success'
        AND p.uid = #{uid}
    </select>
    <select id="getUser" parameterType="int" resultType="com.haebub.dto.User.UserDTO">
        SELECT
        uid
        ,id
        ,name
        ,nickname
        ,email
        ,tel
        ,addr
        FROM user
        where uid = #{uid}
    </select>
    <update id="userModify" parameterType="com.haebub.dto.User.UserDTO">
        UPDATE user
        SET
          id = #{id}
        , name = #{name}
        , nickname = #{nickname}
        , email = #{email}
        , tel = #{tel}
        WHERE uid = #{uid}
    </update>
</mapper>